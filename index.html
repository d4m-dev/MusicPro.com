<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Music Pro Ultimate</title>
    <meta name="description" content="Trải nghiệm nghe nhạc đỉnh cao với giao diện Light/Dark mode">
    <meta name="theme-color" content="#000000">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Performance Hints -->
    <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
    <link rel="preconnect" href="https://github.com" crossorigin>
    <link rel="preconnect" href="https://i.postimg.cc" crossorigin>
    
    <style>
        /* =========================================
           1. CSS VARIABLES & THEME CONFIG
           ========================================= */
        :root {
            /* Default Dark Theme */
            --primary: #2962ff;
            --primary-gradient: linear-gradient(135deg, #2962ff 0%, #0039cb 100%);
            --bg-body: #000000;
            --bg-surface: #121212;
            --bg-surface-trans: rgba(18, 18, 18, 0.85);
            --bg-secondary: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --border: rgba(255, 255, 255, 0.08);
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
            --nav-height: 70px;
            --mini-player-height: 70px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --anim-speed: 0.3s;
        }

        [data-theme="light"] {
            --primary: #2962ff;
            --primary-gradient: linear-gradient(135deg, #448aff 0%, #2962ff 100%);
            --bg-body: #f0f2f5;
            --bg-surface: #ffffff;
            --bg-surface-trans: rgba(255, 255, 255, 0.85);
            --bg-secondary: #f7f9fc;
            --text-main: #1a1b1e;
            --text-sub: #6c757d;
            --border: rgba(0, 0, 0, 0.06);
            --shadow-sm: 0 4px 15px rgba(0,0,0,0.05);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.1);
        }

        /* =========================================
           2. GLOBAL RESET & TYPOGRAPHY
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Urbanist', sans-serif;
            overflow: hidden;
            transition: background-color var(--anim-speed), color var(--anim-speed);
            user-select: none;
        }

        ::-webkit-scrollbar { display: none; }
        button { cursor: pointer; border: none; outline: none; background: none; font-family: inherit; }
        img { user-select: none; pointer-events: none; }

        /* =========================================
           3. COMPONENTS & UTILITIES
           ========================================= */
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        
        /* Icon Button */
        .btn-icon {
            width: 40px; height: 40px; border-radius: 50%;
            color: var(--text-main); display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: all 0.2s ease;
            position: relative; overflow: hidden;
        }
        .btn-icon:active { transform: scale(0.92); background: var(--border); }
        .btn-icon.active { color: var(--primary); }
        
        /* Repeat One Badge */
        .btn-icon.repeat-one::after {
            content: '1'; font-size: 9px; font-weight: 800;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: var(--bg-surface); background: var(--primary);
            width: 14px; height: 14px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-top: -8px; margin-left: 8px; border: 2px solid var(--bg-surface);
        }

        /* Loading Screen */
        #loader {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 9999;
            flex-direction: column; gap: 20px; transition: opacity 0.5s;
        }
        .loader-ring {
            width: 50px; height: 50px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Toast Notification */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: var(--bg-surface); color: var(--text-main);
            padding: 12px 24px; border-radius: 30px;
            box-shadow: var(--shadow-lg); border: 1px solid var(--border);
            z-index: 10000; font-weight: 600; font-size: 14px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px; pointer-events: none;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* =========================================
           4. LAYOUT STRUCTURE
           ========================================= */
        .app-layout {
            height: 100vh; height: 100dvh; display: flex; flex-direction: column;
        }

        /* Header */
        .top-bar {
            height: var(--nav-height); padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-body); z-index: 50;
        }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .logo i { color: var(--primary); }
        .theme-toggle { 
            width: 36px; height: 36px; border-radius: 12px; background: var(--bg-secondary);
            color: var(--text-main); font-size: 16px;
        }

        /* Filter Chips */
        .chips-wrapper { padding: 5px 20px 15px; overflow-x: auto; background: var(--bg-body); z-index: 40; }
        .chips-row { display: flex; gap: 10px; }
        .chip {
            padding: 8px 18px; background: var(--bg-secondary); border-radius: 20px;
            font-size: 14px; font-weight: 600; color: var(--text-sub);
            white-space: nowrap; transition: 0.3s;
        }
        .chip.active { background: var(--text-main); color: var(--bg-body); }

        /* Song List */
        .list-container { flex: 1; overflow-y: auto; padding: 0 20px; }
        .list-header { margin: 10px 0 20px; }
        .list-header h2 { font-size: 26px; font-weight: 700; margin-bottom: 4px; }
        .list-header p { color: var(--text-sub); font-size: 14px; }

        .track-item {
            display: flex; align-items: center; gap: 16px; padding: 12px 0;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .track-thumb {
            width: 60px; height: 60px; border-radius: 12px; overflow: hidden;
            background: var(--bg-secondary); flex-shrink: 0; position: relative;
        }
        .track-thumb img { width: 100%; height: 100%; object-fit: cover; }
        
        .track-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .track-title { font-size: 16px; font-weight: 700; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-artist { font-size: 14px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Active State in List */
        .track-item.active .track-title { color: var(--primary); }
        .track-item.active .track-thumb::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(0,0,0,0.4);
        }
        
        /* Wave Animation (Equalizer) */
        .wave-anim {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; align-items: flex-end; gap: 2px; height: 16px;
        }
        .track-item.active .wave-anim { display: flex; }
        .bar { width: 3px; background: #fff; border-radius: 2px; animation: wave 0.6s infinite ease-in-out alternate; }
        .bar:nth-child(1) { height: 60%; animation-delay: -0.4s; }
        .bar:nth-child(2) { height: 100%; animation-delay: -0.2s; }
        .bar:nth-child(3) { height: 40%; animation-delay: 0s; }
        @keyframes wave { from { height: 30%; } to { height: 100%; } }

        .btn-download-sm { padding: 10px; color: var(--text-sub); font-size: 18px; }

        /* =========================================
           5. MINI PLAYER
           ========================================= */
        .mini-player {
            position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom) + 10px);
            left: 10px; right: 10px; height: var(--mini-player-height);
            background: var(--bg-surface-trans); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg); z-index: 90;
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .mini-player.hide { transform: translateY(200%); }

        .progress-line { width: 100%; height: 2px; background: rgba(128,128,128,0.2); }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }

        .mini-content { flex: 1; display: flex; align-items: center; padding: 0 16px; gap: 12px; }
        .mini-img-box { width: 44px; height: 44px; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
        .mini-img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .mini-text-box { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        .mini-title { font-size: 14px; font-weight: 700; white-space: nowrap; }
        .mini-status { font-size: 12px; color: var(--text-sub); }

        /* =========================================
           6. FULL PLAYER OVERLAY
           ========================================= */
        .player-overlay {
            position: fixed; inset: 0; background: var(--bg-surface);
            z-index: 200; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .player-overlay.open { transform: translateY(0); }

        /* Ambient Glow */
        .ambient-glow {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            width: 150%; height: 70%; border-radius: 50%;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            opacity: 0.15; filter: blur(60px); pointer-events: none; z-index: 0;
            transition: background 1s ease;
        }

        /* Overlay Header */
        .overlay-header {
            padding: 40px 20px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 2;
        }
        
        /* Tabs Switcher */
        .tab-switcher {
            display: flex; background: var(--bg-secondary); padding: 4px; border-radius: 12px;
        }
        .tab-btn {
            padding: 6px 16px; border-radius: 8px; font-size: 12px; font-weight: 700; color: var(--text-sub);
            transition: 0.3s;
        }
        .tab-btn.active { background: var(--bg-surface); color: var(--text-main); box-shadow: var(--shadow-sm); }

        /* Main Content Area */
        .player-stage { flex: 1; position: relative; z-index: 2; overflow: hidden; }
        .stage-view {
            position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.4s ease; transform: scale(0.95);
        }
        .stage-view.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* Artwork View */
        .artwork-card {
            width: 85%; max-width: 380px; aspect-ratio: 1/1;
            border-radius: var(--radius-lg); overflow: hidden;
            box-shadow: var(--shadow-lg); border: 1px solid var(--border);
            position: relative;
        }
        .artwork-card img { width: 100%; height: 100%; object-fit: cover; }

        /* Video View */
        .video-container { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
        video { width: 100%; max-height: 100%; }
        .video-fallback { position: absolute; inset: 0; background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; z-index: 10; }

        /* Lyrics View */
        .lyrics-container { width: 100%; height: 100%; overflow-y: auto; padding: 40px 24px; text-align: left; mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%); }
        .lyric-row { 
            font-size: 24px; font-weight: 700; color: var(--text-sub); margin-bottom: 24px; 
            transition: 0.3s; opacity: 0.4; transform-origin: left; cursor: pointer;
        }
        .lyric-row.active { color: var(--text-main); opacity: 1; transform: scale(1.05); }

        /* Controls */
        .player-controls { padding: 20px 30px 50px; z-index: 2; background: var(--bg-surface); border-top: 1px solid var(--border); border-radius: 30px 30px 0 0; }
        
        .meta-info { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .song-texts { flex: 1; padding-right: 15px; overflow: hidden; }
        
        /* Marquee */
        .marquee-wrapper { overflow: hidden; white-space: nowrap; position: relative; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .marquee-content { display: inline-block; padding-left: 0; }
        .marquee-content.animate { animation: marquee 10s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .text-h1 { font-size: 24px; font-weight: 800; color: var(--text-main); }
        .text-h2 { font-size: 16px; font-weight: 500; color: var(--primary); margin-top: 4px; }

        /* Sliders */
        .slider-group { margin-bottom: 20px; }
        .time-row { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: var(--text-sub); margin-top: 8px; }
        
        input[type=range] {
            width: 100%; -webkit-appearance: none; height: 6px; background: var(--bg-secondary);
            border-radius: 3px; cursor: pointer; position: relative;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px; background: var(--text-main);
            border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: 0.2s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.3); background: var(--primary); }

        /* Main Buttons */
        .controls-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-play-xl {
            width: 76px; height: 76px; border-radius: 50%;
            background: var(--primary-gradient); color: #fff;
            font-size: 32px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(41, 98, 255, 0.4);
            transition: 0.3s;
        }
        .btn-play-xl:active { transform: scale(0.9); }

        /* Volume */
        .vol-wrapper { 
            display: flex; align-items: center; gap: 15px; 
            padding-top: 15px; border-top: 1px solid var(--border); 
        }

        /* =========================================
           7. BOTTOM NAV
           ========================================= */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            background: var(--bg-surface); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 80;
        }
        .nav-link { 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-sub); font-size: 10px; font-weight: 600;
            width: 60px; opacity: 0.7; transition: 0.3s;
        }
        .nav-link i { font-size: 22px; margin-bottom: 2px; }
        .nav-link.active { color: var(--primary); opacity: 1; }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* =========================================
           8. LARGE SCREEN OPTIMIZATION
           ========================================= */
        @media (min-width: 1024px) {
            .app-layout {
                max-width: 1200px;
                margin: 0 auto;
            }

            .top-bar,
            .chips-wrapper,
            .list-container {
                padding-left: 32px;
                padding-right: 32px;
            }

            .list-container {
                padding-bottom: 220px;
            }

            .track-item {
                padding: 14px 0;
            }

            .mini-player {
                left: 50%;
                right: auto;
                width: min(900px, 90vw);
                transform: translateX(-50%);
            }
            .mini-player.hide { transform: translate(-50%, 200%); }

            .bottom-nav {
                left: 50%;
                transform: translateX(-50%);
                width: min(900px, 100%);
                border-radius: 16px 16px 0 0;
            }

            .player-overlay {
                align-items: center;
            }
            .overlay-header,
            .player-stage,
            .player-controls {
                width: min(900px, 100%);
            }
            .artwork-card {
                width: min(210px, 60vw);
                max-width: 210px;
            }
            .lyrics-container { font-size: 26px; }
        }
    </style>
</head>
<body>

    <!-- PRELOADER -->
    <div id="loader" class="flex-center">
        <div class="loader-ring"></div>
        <h3 style="font-weight:700; letter-spacing:1px;">MUSIC PRO</h3>
    </div>

    <!-- TOAST MSG -->
    <div id="toast"><i class="fa-solid fa-circle-check" style="color:var(--primary)"></i> <span id="toast-msg">Thông báo</span></div>

    <div class="app-layout">
        
        <!-- HEADER -->
        <div class="top-bar">
            <div class="logo"><i class="fa-brands fa-youtube"></i> Music Pro</div>
            <div class="flex-center" style="gap: 15px;">
                <button class="theme-toggle flex-center" id="theme-btn"><i class="fa-solid fa-moon"></i></button>
                <div class="avatar" style="width:36px; height:36px; border-radius:50%; overflow:hidden; border:2px solid var(--border);">
                    <img src="https://ui-avatars.com/api/?name=User&background=2962ff&color=fff" style="width:100%">
                </div>
            </div>
        </div>

        <!-- TAGS -->
        <div class="chips-wrapper">
            <div class="chips-row">
                <span class="chip active">Tất cả</span>
                <span class="chip">Thư giãn</span>
                <span class="chip">Tập luyện</span>
                <span class="chip">Yêu thích</span>
                <span class="chip">Trending</span>
            </div>
        </div>

        <!-- TRACK LIST -->
        <div class="list-container" id="main-scroll">
            <div class="list-header">
                <h2>Danh sách phát</h2>
                <p>Cập nhật hôm nay • Dành riêng cho bạn</p>
            </div>
            <div id="track-list"></div>
            <div style="height: 150px;"></div>
        </div>

        <!-- MINI PLAYER -->
        <div class="mini-player hide" id="mini-player">
            <div class="progress-line"><div class="progress-fill" id="mini-fill"></div></div>
            <div class="mini-content" id="mini-click-area">
                <div class="mini-img-box">
                    <img id="mini-img" src="" alt="">
                </div>
                <div class="mini-text-box">
                    <span class="mini-title" id="mini-title">...</span>
                    <span class="mini-status" id="mini-artist">...</span>
                </div>
                <div class="flex-center" style="gap:5px;">
                    <button class="btn-icon" id="btn-mini-play"><i class="fa-solid fa-play"></i></button>
                    <button class="btn-icon" id="btn-mini-next"><i class="fa-solid fa-forward-step"></i></button>
                </div>
            </div>
        </div>

        <!-- FULL PLAYER OVERLAY -->
        <div class="player-overlay" id="player-overlay">
            <div class="ambient-glow" id="ambient-light"></div>
            
            <!-- OVERLAY HEADER -->
            <div class="overlay-header">
                <button class="btn-icon" id="btn-close"><i class="fa-solid fa-chevron-down"></i></button>
                <div class="tab-switcher">
                    <div class="tab-btn active" data-tab="song">SONG</div>
                    <div class="tab-btn" data-tab="video">VIDEO</div>
                    <div class="tab-btn" data-tab="lyrics">LYRICS</div>
                </div>
                <button class="btn-icon"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </div>

            <!-- CONTENT STAGE -->
            <div class="player-stage">
                
                <!-- VIEW: SONG -->
                <div class="stage-view active" id="view-song">
                    <div class="artwork-card">
                        <img id="full-artwork" src="" alt="">
                    </div>
                </div>

                <!-- VIEW: VIDEO -->
                <div class="stage-view" id="view-video">
                    <div class="video-container">
                        <video id="video-element" playsinline webkit-playsinline></video>
                        <div class="video-fallback" id="video-msg">
                            <div class="loader-ring" style="width:30px;height:30px;border-width:3px;"></div>
                            <span>Đang tải Video...</span>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LYRICS -->
                <div class="stage-view" id="view-lyrics">
                    <div class="lyrics-container" id="lyrics-content">
                        <p style="text-align:center; color:var(--text-sub);">Đang tải lời bài hát...</p>
                    </div>
                </div>
            </div>

            <!-- CONTROLS PANEL -->
            <div class="player-controls">
                
                <div class="meta-info">
                    <div class="song-texts">
                        <div class="marquee-wrapper" id="marquee-box-title">
                            <span class="marquee-content text-h1" id="full-title">Tiêu đề bài hát</span>
                        </div>
                        <div class="marquee-wrapper" id="marquee-box-artist">
                            <span class="marquee-content text-h2" id="full-artist">Tên ca sĩ</span>
                        </div>
                    </div>
                    <div class="flex-center" style="gap:10px;">
                        <button class="btn-icon" id="btn-dl"><i class="fa-solid fa-download"></i></button>
                        <button class="btn-icon" id="btn-heart"><i class="fa-regular fa-heart"></i></button>
                    </div>
                </div>

                <div class="slider-group">
                    <div class="progress-container" style="display:flex; align-items:center; gap:10px;">
                        <span id="curr-time" style="font-size:12px; color:var(--text-sub); width:40px;">0:00</span>
                        <input type="range" id="seek-bar" value="0" min="0" max="100" step="0.1">
                        <span id="total-time" style="font-size:12px; color:var(--text-sub); width:40px;">0:00</span>
                    </div>
                </div>

                <div class="controls-row">
                    <button class="btn-icon" id="btn-shuffle"><i class="fa-solid fa-shuffle"></i></button>
                    <button class="btn-icon" id="btn-prev" style="font-size:24px;"><i class="fa-solid fa-backward-step"></i></button>
                    <button class="btn-play-xl" id="btn-main-play"><i class="fa-solid fa-play"></i></button>
                    <button class="btn-icon" id="btn-next" style="font-size:24px;"><i class="fa-solid fa-forward-step"></i></button>
                    <button class="btn-icon" id="btn-repeat"><i class="fa-solid fa-repeat"></i></button>
                </div>

                <div class="vol-wrapper">
                    <button class="btn-icon" id="btn-mute" style="width:30px; height:30px; font-size:16px;">
                        <i class="fa-solid fa-volume-high"></i>
                    </button>
                    <input type="range" id="vol-bar" min="0" max="1" step="0.05" value="0.8">
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <nav class="bottom-nav">
            <div class="nav-link active">
                <i class="fa-solid fa-house"></i> <span>Trang chủ</span>
            </div>
            <div class="nav-link">
                <i class="fa-solid fa-compass"></i> <span>Khám phá</span>
            </div>
            <div class="nav-link">
                <i class="fa-solid fa-book-open"></i> <span>Thư viện</span>
            </div>
        </nav>

    </div>

    <!-- MAIN APP SCRIPT -->
    <script type="module">
        const TRACKS_URL = 'https://raw.githubusercontent.com/d4m-dev/media/refs/heads/main/load-track/tracks.js';
        const normalizeTracks = (items = []) => items.map((item) => ({
            name: item.title || item.name || 'Tạm thời chưa có!',
            artist: item.artist || 'Tạm thời chưa có!',
            artwork: item.cover || item.artwork || 'Tạm thời chưa có!',
            path: item.audioSrc || item.path || 'Tạm thời chưa có!',
            instrumental: item.instrumentalSrc || item.instrumental || 'Tạm thời chưa có!',
            vid: item.videoSrc || item.vid || 'Tạm thời chưa có!',
            lyric: item.lyricSrc || item.lyric || 'Tạm thời chưa có!'
        }));

        const loadRemoteTracks = async () => {
            if (Array.isArray(window.TRACKS) && window.TRACKS.length) return window.TRACKS;
            try {
                const res = await fetch(TRACKS_URL, { cache: 'no-store' });
                const text = await res.text();
                const sandbox = {};
                const getter = new Function('window', `${text}; return window.TRACKS || [];`);
                const data = getter(sandbox);
                return Array.isArray(data) ? data : [];
            } catch (e) {
                return [];
            }
        };

        class MusicPro {
            constructor() {
                this.state = {
                    playlist: [],
                    currentIndex: 0,
                    isPlaying: false,
                    isShuffle: false,
                    repeatMode: 0, // 0: All, 1: One
                    currentMode: 'audio', // 'audio' | 'video'
                    volume: 0.8,
                    isMuted: false,
                    theme: localStorage.getItem('theme') || 'dark'
                };

                this.audio = new Audio();
                this.video = document.getElementById('video-element');
                this.lyricsData = [];

                this.elements = {
                    loader: document.getElementById('loader'),
                    list: document.getElementById('track-list'),
                    overlay: document.getElementById('player-overlay'),
                    mini: document.getElementById('mini-player'),
                    toast: document.getElementById('toast'),
                    toastMsg: document.getElementById('toast-msg'),
                    playBtnMain: document.getElementById('btn-main-play'),
                    playBtnMini: document.getElementById('btn-mini-play'),
                    seekBar: document.getElementById('seek-bar'),
                    miniFill: document.getElementById('mini-fill'),
                    ambient: document.getElementById('ambient-light'),
                    videoMsg: document.getElementById('video-msg')
                };

                this.init();
            }

            async init() {
                this.applyTheme();
                const rawTracks = await loadRemoteTracks();
                this.state.playlist = normalizeTracks(rawTracks);
                this.renderPlaylist();
                if (!this.state.playlist.length) {
                    this.showToast('Không tải được danh sách phát');
                }
                
                // Load first song but don't play
                if (this.state.playlist.length > 0) {
                    this.loadSong(0, false);
                }

                // Simulate loading
                setTimeout(() => {
                    this.elements.loader.style.opacity = '0';
                    setTimeout(() => this.elements.loader.style.display = 'none', 500);
                }, 800);

                this.setupEventListeners();
            }

            // --- THEME ENGINE ---
            applyTheme() {
                document.documentElement.setAttribute('data-theme', this.state.theme);
                const icon = document.querySelector('#theme-btn i');
                icon.className = this.state.theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
            }

            toggleTheme() {
                this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', this.state.theme);
                this.applyTheme();
                this.showToast(`Đã chuyển sang ${this.state.theme === 'dark' ? 'Giao diện tối' : 'Giao diện sáng'}`);
            }

            // --- RENDER ---
            renderPlaylist() {
                this.elements.list.innerHTML = '';
                if (!this.state.playlist.length) {
                    this.elements.list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sub);">Không tải được danh sách phát</div>';
                    return;
                }
                this.state.playlist.forEach((track, index) => {
                    const item = document.createElement('div');
                    item.className = 'track-item';
                    item.innerHTML = `
                        <div class="track-thumb">
                            <img src="${track.artwork}" loading="lazy">
                            <div class="wave-anim">
                                <div class="bar"></div><div class="bar"></div><div class="bar"></div>
                            </div>
                        </div>
                        <div class="track-info">
                            <div class="track-title">${track.name}</div>
                            <div class="track-artist">${track.artist}</div>
                        </div>
                        <button class="btn-icon btn-download-sm" onclick="event.stopPropagation(); app.downloadSong(${index})">
                            <i class="fa-solid fa-download"></i>
                        </button>
                    `;
                    item.onclick = (e) => {
                        if (!e.target.closest('.btn-download-sm')) this.playIndex(index);
                    };
                    this.elements.list.appendChild(item);
                });
            }

            // --- PLAYER LOGIC ---
            loadSong(index, autoPlay = true) {
                this.state.currentIndex = index;
                const song = this.state.playlist[index];

                // Update UI Texts
                document.getElementById('full-title').innerText = song.name;
                document.getElementById('full-artist').innerText = song.artist;
                document.getElementById('mini-title').innerText = song.name;
                document.getElementById('mini-artist').innerText = song.artist;
                
                // Update Images
                document.getElementById('full-artwork').src = song.artwork;
                document.getElementById('mini-img').src = song.artwork;

                // Reset Media
                this.audio.src = song.path;
                
                // Video Logic Check
                const hasVideo = song.vid && !song.vid.includes('..4.mp4') && !song.vid.includes('ERROR');
                this.video.src = hasVideo ? song.vid : '';
                this.elements.videoMsg.style.display = 'none'; // Hide error initially

                // Load Lyrics
                this.loadLyrics(song.lyric);

                // Update Active State List
                document.querySelectorAll('.track-item').forEach((el, i) => {
                    el.classList.toggle('active', i === index);
                });

                // Ambient Color (Fake logic - random hue based on index)
                const hue = (index * 50) % 360;
                this.elements.ambient.style.background = `radial-gradient(circle, hsl(${hue}, 70%, 50%) 0%, transparent 70%)`;

                // Auto Play Logic
                if (autoPlay) {
                    if (this.state.currentMode === 'video' && this.video.src) {
                        this.playVideo();
                    } else {
                        // If in video mode but no video, switch back to audio view
                        if (this.state.currentMode === 'video' && !this.video.src) {
                            this.showToast('Video không khả dụng');
                            this.switchTab('song'); // This sets mode to audio
                        }
                        this.playAudio();
                    }
                }

                this.checkMarquee();
            }

            playIndex(index) {
                this.loadSong(index, true);
            }

            // --- MEDIA CONTROL ---
            playAudio() {
                this.video.pause();
                this.state.currentMode = 'audio';
                this.audio.play().then(() => {
                    this.state.isPlaying = true;
                    this.updatePlayState();
                }).catch(e => console.warn('Audio play block', e));
            }

            playVideo() {
                this.audio.pause();
                this.state.currentMode = 'video';
                
                // Show loader
                this.elements.videoMsg.style.display = 'flex';
                this.elements.videoMsg.innerHTML = '<div class="loader-ring" style="width:30px;height:30px;border-width:3px;"></div><span>Đang tải Video...</span>';

                const playPromise = this.video.play();
                if (playPromise) {
                    playPromise.then(() => {
                        this.state.isPlaying = true;
                        this.updatePlayState();
                        this.elements.videoMsg.style.display = 'none';
                    }).catch(() => {
                        this.state.isPlaying = false;
                        this.updatePlayState();
                        this.elements.videoMsg.style.display = 'flex';
                        this.elements.videoMsg.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="font-size:24px;margin-bottom:8px;"></i><span>Video lỗi</span>';
                    });
                }
            }

            pause() {
                this.audio.pause();
                this.video.pause();
                this.state.isPlaying = false;
                this.updatePlayState();
            }

            togglePlay() {
                if (this.state.isPlaying) {
                    this.pause();
                } else {
                    if (this.state.currentMode === 'video' && this.video.src) this.playVideo();
                    else this.playAudio();
                }
            }

            updatePlayState() {
                const icon = this.state.isPlaying ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
                this.elements.playBtnMain.innerHTML = icon;
                this.elements.playBtnMini.innerHTML = icon;
                
                // Animation controls
                const anims = document.querySelectorAll('.wave-anim .bar');
                anims.forEach(bar => bar.style.animationPlayState = this.state.isPlaying ? 'running' : 'paused');
                
                if (this.state.isPlaying) this.elements.mini.classList.remove('hide');
            }

            next() {
                let idx;
                if (this.state.isShuffle) {
                    do {
                        idx = Math.floor(Math.random() * this.state.playlist.length);
                    } while (idx === this.state.currentIndex && this.state.playlist.length > 1);
                } else {
                    idx = this.state.currentIndex + 1;
                    if (idx >= this.state.playlist.length) idx = 0;
                }
                this.loadSong(idx, true);
            }

            prev() {
                let idx = this.state.currentIndex - 1;
                if (idx < 0) idx = this.state.playlist.length - 1;
                this.loadSong(idx, true);
            }

            // --- SYNC & EVENTS ---
            setupEventListeners() {
                // Audio & Video Time Update
                const onTimeUpdate = (src) => {
                    const duration = src.duration || 0;
                    const current = src.currentTime || 0;
                    if (duration > 0) {
                        const percent = (current / duration) * 100;
                        this.elements.seekBar.value = percent;
                        this.elements.miniFill.style.width = percent + '%';
                        
                        document.getElementById('curr-time').innerText = this.formatTime(current);
                        document.getElementById('total-time').innerText = this.formatTime(duration);
                        
                        this.syncLyrics(current);
                    }
                };
                
                this.audio.ontimeupdate = () => onTimeUpdate(this.audio);
                this.video.ontimeupdate = () => onTimeUpdate(this.video);

                // Ended
                const onEnd = () => {
                    if (this.state.repeatMode === 1) { // Repeat One
                        this.state.currentMode === 'video' ? (this.video.currentTime = 0, this.video.play()) : (this.audio.currentTime = 0, this.audio.play());
                    } else {
                        this.next();
                    }
                };
                this.audio.onended = onEnd;
                this.video.onended = onEnd;

                // Seek Bar
                this.elements.seekBar.oninput = (e) => {
                    const percent = e.target.value;
                    const duration = this.state.currentMode === 'video' ? this.video.duration : this.audio.duration;
                    if (duration) {
                        const time = (percent / 100) * duration;
                        if (this.state.currentMode === 'video') this.video.currentTime = time;
                        else this.audio.currentTime = time;
                    }
                };

                // Volume
                const volBar = document.getElementById('vol-bar');
                volBar.oninput = (e) => {
                    const val = e.target.value;
                    this.state.volume = val;
                    this.audio.volume = val;
                    this.video.volume = val;
                    this.state.isMuted = val == 0;
                    this.updateMuteUI();
                };

                document.getElementById('btn-mute').onclick = () => {
                    if (this.state.isMuted) {
                        this.state.volume = 0.8;
                        this.state.isMuted = false;
                    } else {
                        this.state.volume = 0;
                        this.state.isMuted = true;
                    }
                    this.audio.volume = this.state.volume;
                    this.video.volume = this.state.volume;
                    volBar.value = this.state.volume;
                    this.updateMuteUI();
                };

                // Main Buttons
                this.elements.playBtnMain.onclick = () => this.togglePlay();
                this.elements.playBtnMini.onclick = (e) => { e.stopPropagation(); this.togglePlay(); };
                document.getElementById('btn-next').onclick = () => this.next();
                document.getElementById('btn-mini-next').onclick = (e) => { e.stopPropagation(); this.next(); };
                document.getElementById('btn-prev').onclick = () => this.prev();

                // Shuffle
                document.getElementById('btn-shuffle').onclick = (e) => {
                    this.state.isShuffle = !this.state.isShuffle;
                    e.currentTarget.classList.toggle('active', this.state.isShuffle);
                    this.showToast(this.state.isShuffle ? 'Đã bật trộn bài' : 'Đã tắt trộn bài');
                };

                // Repeat
                document.getElementById('btn-repeat').onclick = (e) => {
                    const btn = e.currentTarget;
                    if (this.state.repeatMode === 0) {
                        this.state.repeatMode = 1; // Repeat One
                        btn.classList.add('active', 'repeat-one');
                        this.showToast('Lặp lại 1 bài');
                    } else {
                        this.state.repeatMode = 0; // Repeat All
                        btn.classList.remove('active', 'repeat-one');
                        this.showToast('Lặp lại danh sách');
                    }
                };

                // Theme
                document.getElementById('theme-btn').onclick = () => this.toggleTheme();

                // Overlay & Tabs
                document.getElementById('mini-click-area').onclick = () => this.elements.overlay.classList.add('open');
                document.getElementById('btn-close').onclick = () => this.elements.overlay.classList.remove('open');

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.onclick = () => this.switchTab(btn.dataset.tab);
                });

                // Download
                document.getElementById('btn-dl').onclick = () => this.downloadSong(this.state.currentIndex);
            }

            updateMuteUI() {
                const btn = document.getElementById('btn-mute');
                if (this.state.isMuted) {
                    btn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
                    btn.style.color = 'var(--text-sub)';
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                    btn.style.color = 'var(--text-main)';
                }
            }

            switchTab(tabName) {
                // UI
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                document.querySelectorAll('.stage-view').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${tabName}`).classList.add('active');

                // Logic Handover
                if (tabName === 'video') {
                    if (this.state.currentMode !== 'video') {
                        this.state.currentMode = 'video';
                        const t = this.audio.currentTime;
                        this.audio.pause();
                        
                        // Check if video exists
                        if (this.video.src && !this.video.src.endsWith(window.location.href)) {
                            this.video.currentTime = t;
                            if (this.state.isPlaying) this.playVideo();
                        } else {
                            this.elements.videoMsg.style.display = 'flex';
                            this.elements.videoMsg.innerHTML = '<span>Không có Video</span>';
                            this.state.isPlaying = false;
                            this.updatePlayState();
                        }
                    }
                } else {
                    // Switching to Audio views (Song/Lyrics)
                    if (this.state.currentMode === 'video') {
                        this.state.currentMode = 'audio';
                        const t = this.video.currentTime;
                        this.video.pause();
                        this.audio.currentTime = t;
                        if (this.state.isPlaying) this.playAudio();
                    }
                }
            }

            // --- LYRICS ---
            async loadLyrics(url) {
                const container = document.getElementById('lyrics-content');
                container.innerHTML = '<p style="text-align:center; color:var(--text-sub); margin-top:50px;">Đang tải...</p>';
                this.lyricsData = [];

                if (!url) {
                    container.innerHTML = '<p style="text-align:center; color:var(--text-sub); margin-top:50px;">Không có lời bài hát</p>';
                    return;
                }

                try {
                    const res = await fetch(url);
                    const text = await res.text();
                    const lines = text.split('\n');
                    const regex = /^\[(\d{2}):(\d{2})(\.\d+)?\](.*)/;
                    
                    container.innerHTML = '<div style="height: 40vh;"></div>'; // Spacer top
                    
                    lines.forEach((line, i) => {
                        const match = line.match(regex);
                        if (match) {
                            const min = parseInt(match[1]);
                            const sec = parseInt(match[2]);
                            const ms = match[3] ? parseFloat(match[3]) : 0;
                            const time = min * 60 + sec + ms;
                            const content = match[4].trim();
                            
                            if (content) {
                                this.lyricsData.push({ time, id: `line-${i}` });
                                const p = document.createElement('p');
                                p.className = 'lyric-row';
                                p.id = `line-${i}`;
                                p.innerText = content;
                                p.onclick = () => {
                                    if (this.state.currentMode === 'video') this.video.currentTime = time;
                                    else this.audio.currentTime = time;
                                };
                                container.appendChild(p);
                            }
                        }
                    });
                    container.innerHTML += '<div style="height: 40vh;"></div>'; // Spacer bottom
                } catch (e) {
                    container.innerHTML = '<p style="text-align:center; color:var(--text-sub); margin-top:50px;">Lỗi tải lời bài hát</p>';
                }
            }

            syncLyrics(time) {
                if (this.lyricsData.length === 0) return;
                
                let activeId = null;
                for (let i = 0; i < this.lyricsData.length; i++) {
                    if (this.lyricsData[i].time <= time) {
                        activeId = this.lyricsData[i].id;
                    } else {
                        break;
                    }
                }

                if (activeId) {
                    const current = document.querySelector('.lyric-row.active');
                    if (current && current.id !== activeId) {
                        current.classList.remove('active');
                    }
                    
                    const next = document.getElementById(activeId);
                    if (next && !next.classList.contains('active')) {
                        next.classList.add('active');
                        next.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }

            // --- UTILS ---
            checkMarquee() {
                const title = document.getElementById('full-title');
                const box = document.getElementById('marquee-box-title');
                const content = title.parentElement;
                
                content.classList.remove('animate');
                void title.offsetWidth; // Trigger reflow
                
                if (title.offsetWidth > box.offsetWidth) {
                    content.classList.add('animate');
                    // Duplicate text for smooth loop
                    if (!title.getAttribute('data-doubled')) {
                        title.innerHTML += ` &nbsp; • &nbsp; ${title.innerHTML}`;
                        title.setAttribute('data-doubled', 'true');
                    }
                }
            }

            downloadSong(index) {
                const song = this.state.playlist[index];
                const link = document.createElement('a');
                link.href = song.path;
                link.download = `${song.name}.mp3`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast(`Đang tải: ${song.name}`);
            }

            showToast(msg) {
                this.elements.toastMsg.innerText = msg;
                this.elements.toast.classList.add('show');
                setTimeout(() => this.elements.toast.classList.remove('show'), 3000);
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            }
        }

        // Initialize App
        window.app = new MusicPro();
    </script>
</body>
</html>


